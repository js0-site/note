var BUILDIN, JS_SUFFIX, NODE_PATH;

import {
  existsSync
} from 'fs';

JS_SUFFIX = '.js';

BUILDIN = new Set(['fs', 'stream', 'zx', 'assert']);

({NODE_PATH} = process.env);

if (NODE_PATH) {
  NODE_PATH = NODE_PATH.replaceAll(';').split(':');
} else {
  NODE_PATH = [];
}

export default async(specifier, cx, defaultResolve) => {
  var begin, err, i, li, parentURL, pos;
  ({parentURL} = cx);
  if (!specifier.includes(':')) {
    if (!parentURL.includes('/node_modules/')) {
      li = specifier.split('/');
      if (li.length) {
        if (!BUILDIN.has(li[0])) {
          if (specifier.startsWith('@')) {
            begin = specifier.indexOf('/', 1) + 1;
          } else {
            begin = 1;
          }
          pos = specifier.indexOf('/', begin);
          if (pos > 0 && !li.pop().includes('.')) {
            specifier += JS_SUFFIX;
          }
        }
      }
    }
  }
  try {
    return (await defaultResolve(specifier, cx));
  } catch (error) {
    err = error;
    if (!specifier.startsWith('.')) {
      for (i of NODE_PATH) {
        cx.parentURL = 'file://' + i;
        try {
          return (await defaultResolve(specifier, cx));
        } catch (error) {
          continue;
        }
      }
    }
  }
  throw err;
};
