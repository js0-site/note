#!/usr/bin/env -S node --trace-uncaught --expose-gc --unhandled-rejections=strict --experimental-wasm-modules
var copySync;

import {
  walkRel
} from '@3-/walk';

import write from '@3-/write';

import {
  readFileSync,
  statSync,
  constants,
  chmodSync,
  rmSync,
  copyFileSync,
  mkdirSync
} from 'fs';

import {
  join,
  dirname,
  basename
} from 'path';

import fsExtra from 'fs-extra';

import compile from './compile.js';

({copySync} = fsExtra);

export default async(src, outdir, ext = 'js') => {
  var filedir, fp, ofp, out, out_not_src, ref;
  ext = '.' + ext;
  out = (dir, filedir, fp) => {
    var cf, cfp, ofp;
    cfp = join(filedir, fp);
    cf = readFileSync(cfp, 'utf8');
    if (fp.endsWith('.coffee')) {
      fp = fp.slice(0, -7);
    }
    ofp = join(dir, fp + ext);
    console.log(ofp);
    write(ofp, compile(cf, {
      noHeader: true,
      bare: true
    }));
    if ((statSync(cfp)).mode & constants.S_IXUSR) {
      chmodSync(ofp, 0o755);
    }
  };
  if (statSync(src).isDirectory()) {
    if (outdir) {
      out_not_src = outdir !== src;
    } else {
      outdir = src;
      out_not_src = 0;
    }
    ref = walkRel(src, (i) => {
      var o;
      if (i.endsWith("/.git")) {
        return true;
      }
      if (i.endsWith("/node_modules")) {
        o = join(outdir, i);
        rmSync(o, {
          force: true,
          recursive: true
        });
        copySync(join(src, i), o, {
          overwrite: true
        });
        return true;
      }
    });
    for await (fp of ref) {
      if (fp.endsWith('.coffee')) {
        out(outdir, src, fp);
      } else if (out_not_src) {
        ofp = join(outdir, fp);
        mkdirSync(dirname(ofp), {
          recursive: true
        });
        copyFileSync(join(src, fp), ofp);
      }
    }
  } else {
    filedir = dirname(src);
    if (!outdir) {
      outdir = filedir;
    }
    out(outdir, filedir, basename(src));
  }
};
