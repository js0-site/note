import chokidar from 'chokidar';

import write from '@3-/write';

import read from '@3-/read';

import {
  dirname,
  join,
  relative,
  extname
} from 'path';

import {
  mkdirSync,
  copyFileSync,
  unlinkSync,
  existsSync
} from 'fs';

import compile from './compile.js';

import run from './run.js';

export default (srcdir, outdir, sh) => {
  var kill, restart, watcher;
  if (sh) {
    [restart, kill] = run(sh);
  }
  watcher = chokidar.watch(srcdir, {
    ignored: /(^|\/)\../,
    persistent: true
  });
  watcher.on('all', function(event, fp) {
    var e, ext, is_coffee, js, ofp, rfp, target_dir;
    rfp = relative(srcdir, fp);
    ext = extname(fp);
    is_coffee = ext === '.coffee';
    ofp = join(outdir, rfp);
    if (is_coffee) {
      ofp = ofp.slice(0, -6) + 'js';
    }
    switch (event) {
      case 'unlink':
        if (existsSync(ofp)) {
          console.log('rm ' + rfp);
          unlinkSync(ofp);
        }
        break;
      // restart?()
      case 'add':
      case 'change':
        if (is_coffee) {
          try {
            js = compile(read(fp), {
              noHeader: true,
              bare: true
            });
            write(ofp, js);
            console.log(rfp);
          } catch (error) {
            e = error;
            console.error(rfp + '\nâŒ ' + e.toString());
            return;
          }
        } else {
          target_dir = dirname(ofp);
          mkdirSync(target_dir, {
            recursive: true
          });
          copyFileSync(fp, ofp);
        }
        if (typeof restart === "function") {
          restart(ofp);
        }
    }
  });
  process.stdin.resume();
  process.on('SIGINT', () => {
    if (typeof kill === "function") {
      kill();
    }
    watcher.close();
    process.exit();
  });
};
