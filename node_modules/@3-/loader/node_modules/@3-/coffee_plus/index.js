#!/usr/bin/env -S node --loader=@w5/jsext --trace-uncaught --expose-gc --unhandled-rejections=strict --experimental-import-meta-resolve
var coffee_label, label;

import gt_import from './import.js';

coffee_label = (code) => {
  var _export, argp, c0, eqp, i, indent, j, len, li, line, pos, pre, pre_indent, ref, s, word;
  li = [];
  pre_indent = 0;
  pre = 0;
  -0;
  OUT: //;
  for (line of code) {
    s = line.trimStart();
    indent = line.length - s.length;
    if (pre) {
      li.push(''.padEnd(pre_indent) + "if null #" + pre.trim());
      pre = 0;
    }
    if (s.startsWith(':')) {
      pos = s.search(/\s/);
      if (~pos) {
        li.push(''.padEnd(indent) + '$|' + s.slice(pos));
      } else {
        pre_indent = indent;
        pre = line;
      }
    } else {
      indent = ''.padEnd(indent);
      c0 = s.charAt(0);
      if (s.startsWith('@->') || (s.startsWith('@(') && s.endsWith(')->'))) {
        li.push(indent + 'constructor:' + s.slice(1));
      } else if (s.startsWith('< class ')) {
        li.push(indent + 'export' + s.slice(1));
      } else if ((~'+<'.indexOf(c0)) && ' ' === s.charAt(1)) {
        pos = s.indexOf('=>');
        if (pos < 0) {
          pos = s.indexOf('->');
          if (pos < 0) {
            pos = s.indexOf('{');
            if (pos < 0) {
              pos = s.indexOf('new ');
              if (pos < 0) {
                pos = s.indexOf('[');
              }
            }
          }
        }
        if (pos > 0) {
          _export = 'export ';
          eqp = s.indexOf('=');
          if ((eqp < 0) || (eqp === pos)) {
            _export += 'default ';
          } else {
            argp = s.indexOf('(');
            if (argp > 0 && eqp > argp) {
              _export += 'default ';
            }
          }
          li.push(_export + s.slice(1).trimStart());
        } else {
          s = s.slice(2).split(',').map((i) => {
            return i.trim();
          }).filter(Boolean);
          for (j = 0, len = s.length; j < len; j++) {
            i = s[j];
            pos = i.indexOf('=');
            if (pos < 0) {
              i += '=`undefined`#' + c0;
            }
            if (c0 === '<') {
              i = 'export ' + i;
            }
            li.push(indent + i);
          }
        }
      } else {
        ref = ['break ', 'continue '];
        for (word of ref) {
          if (s.startsWith(word)) {
            li.push(line.replace(word, '`' + word) + '`');
            continue OUT;
          }
        }
        li.push(line);
      }
    }
  }
  return li.join('\n');
};

label = (code) => {
  var indent, j, len, li, line, push, s, txt;
  li = [];
  code = code.split('\n');
  if (code[0] === '//!/usr/bin/env coffee') {
    li.push('#!/usr/bin/env -S node --import=@3-/jsext --trace-uncaught --expose-gc --unhandled-rejections=strict');
    code = code.slice(1);
  }
  for (j = 0, len = code.length; j < len; j++) {
    line = code[j];
    s = line.trimStart();
    indent = line.length - s.length;
    push = (txt) => {
      li.push(''.padEnd(indent) + txt);
    };
    if (s.startsWith('export var ') && s.endsWith('=> {')) {
      li.push('export const' + s.slice(10));
    } else if (s.endsWith(' = undefined; //+')) {
      continue;
    } else if (s.endsWith(' = undefined; //<')) {
      li.push(line.slice(0, -17) + ';');
    } else if (s.startsWith('if (null) { //:')) {
      push(s.slice(15) + ' : {');
    } else if (s.startsWith('$ | (')) {
      s = s.slice(4);
      if (s.indexOf('function(') > 0 || s.indexOf('=>') > 0) {
        txt = s;
      } else {
        txt = s.slice(1, -2) + ';';
      }
      push('$ : ' + txt);
    } else if (s.startsWith('(() => { //:')) {
      push(s.slice(12) + ' : ({');
    } else {
      li.push(line);
    }
  }
  return li.join('\n');
};

export const coffee_plus = (CoffeeScript) => {
  var compile;
  ({compile} = CoffeeScript);
  compile.bind(CoffeeScript);
  return (code, ...args) => {
    var r;
    code = coffee_label(gt_import(code.split("\n")));
    r = compile(code, ...args);
    if (typeof r === 'string') {
      return label(r);
    } else {
      r.js = label(r.js);
      return r;
    }
  };
};

export default (CoffeeScript) => {
  return CoffeeScript.compile = coffee_plus(CoffeeScript);
};
